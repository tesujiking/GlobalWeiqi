<!-- 围棋等级分计算器 -->
<div style="padding: 20px; max-width: 800px; margin: 0 auto;">
    <div style="text-align: center; margin-bottom: 30px;">
        <h2 style="color: #2c3e50; margin-bottom: 10px;">围棋等级分计算器</h2>
        <p style="color: #666;">EGF官方算法，支持棋份调整</p>
    </div>
    
    <!-- 输入表单 -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
        <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">黑方等级分:</label>
            <input type="number" id="blackRating" value="2100" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
        </div>
        <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">白方等级分:</label>
            <input type="number" id="whiteRating" value="2100" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
        </div>
        <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">让子数:</label>
            <input type="number" id="handicap" value="0" min="0" max="9" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
        </div>
        <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">比赛结果:</label>
            <select id="gameResult" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                <option value="黑胜">黑胜</option>
                <option value="白胜">白胜</option>
                <option value="和棋">和棋</option>
            </select>
        </div>
    </div>
    
    <button onclick="calculateRating()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 20px;">
        计算新等级分
    </button>
    
    <!-- 结果显示 -->
    <div id="result" style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef;">
        <div style="text-align: center; color: #666;">请输入参数并点击计算</div>
    </div>
</div>

<script>
function calculateRating() {
    const r1 = parseFloat(document.getElementById('blackRating').value);
    const r2 = parseFloat(document.getElementById('whiteRating').value);
    const handicap = parseInt(document.getElementById('handicap').value);
    const result = document.getElementById('gameResult').value;
    
    if (isNaN(r1) || isNaN(r2) || isNaN(handicap)) {
        document.getElementById('result').innerHTML = '<div style="color: #e74c3c; text-align: center;">请输入有效数字</div>';
        return;
    }
    
    // EGF算法
    let adjusted_r1 = handicap > 0 ? r1 + (handicap - 0.5) * 100 : r1;
    
    const beta = (r) => -7 * Math.log(Math.min(3300, 3299.9) - Math.min(r, 3299.9));
    const con = (r) => Math.pow((3300 - r) / 200, 1.6);
    const bonus = (r) => Math.log(1 + Math.exp((2300 - r) / 80)) / 5;
    
    const Se1 = 1 / (1 + Math.exp(beta(r2) - beta(adjusted_r1)));
    const Se2 = 1 - Se1;
    
    let Sa1, Sa2;
    if (result === '黑胜') [Sa1, Sa2] = [1.0, 0.0];
    else if (result === '白胜') [Sa1, Sa2] = [0.0, 1.0];
    else [Sa1, Sa2] = [0.5, 0.5];
    
    const new_r1 = r1 + con(r1) * (Sa1 - Se1) + bonus(r1);
    const new_r2 = r2 + con(r2) * (Sa2 - Se2) + bonus(r2);
    
    const change1 = (new_r1 - r1).toFixed(2);
    const change2 = (new_r2 - r2).toFixed(2);
    
    function getRank(rating) {
        if (rating >= 2050) {
            const level = Math.floor((rating - 2050) / 100) + 1;
            const decimal = Math.floor(((rating - 2050) % 100) / 10);
            return `${level}.${decimal}D`;
        } else {
            const level = Math.floor((2050 - rating) / 100) + 1;
            const decimal = Math.floor((2050 - (level - 1) * 100 - rating) / 10);
            return `${level}.${decimal}K`;
        }
    }
    
    const se1_percent = (Se1 * 100).toFixed(1);
    const se2_percent = (Se2 * 100).toFixed(1);
    
    document.getElementById('result').innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #2c3e50;">
                <h4 style="margin: 0 0 10px 0; color: #2c3e50;">黑方</h4>
                <div>原: ${r1} (${getRank(r1)})</div>
                <div style="font-weight: bold; color: #667eea;">新: ${new_r1.toFixed(2)} (${getRank(new_r1)})</div>
                <div>变化: <span style="color: ${change1 >= 0 ? '#27ae60' : '#e74c3c'}">${change1 > 0 ? '+' : ''}${change1}</span></div>
            </div>
            <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #95a5a6;">
                <h4 style="margin: 0 0 10px 0; color: #2c3e50;">白方</h4>
                <div>原: ${r2} (${getRank(r2)})</div>
                <div style="font-weight: bold; color: #667eea;">新: ${new_r2.toFixed(2)} (${getRank(new_r2)})</div>
                <div>变化: <span style="color: ${change2 >= 0 ? '#27ae60' : '#e74c3c'}">${change2 > 0 ? '+' : ''}${change2}</span></div>
            </div>
        </div>
        <div style="text-align: center;">
            <h4 style="color: #2c3e50; margin-bottom: 10px;">预期胜率</h4>
            <div style="display: flex; height: 30px; border-radius: 15px; overflow: hidden; border: 1px solid #ddd;">
                <div style="background: #2c3e50; color: white; width: ${se1_percent}%; display: flex; align-items: center; justify-content: center; font-size: 12px;">
                    黑 ${se1_percent}%
                </div>
                <div style="background: #95a5a6; color: white; width: ${se2_percent}%; display: flex; align-items: center; justify-content: center; font-size: 12px;">
                    白 ${se2_percent}%
                </div>
            </div>
        </div>
    `;
}
</script>
