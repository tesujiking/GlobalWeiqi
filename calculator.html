<!-- 围棋等级分计算器 - 嵌入式版本 -->
<div style="padding: 40px; background: transparent;">
    <!-- 标题区域 -->
    <div style="text-align: center; margin-bottom: 30px;">
        <h1 style="font-size: 32px; font-weight: 700; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 10px;">🔢 围棋等级分计算器</h1>
        <p style="color: #7f8c8d; font-size: 16px;">用于独立验证包含棋份调整的等级分(Rating)与段位(Rank)</p>
    </div>
    
    <!-- 输入表单 -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; margin-bottom: 30px;">
        <div style="display: flex; flex-direction: column;">
            <label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; font-size: 14px;">⚫ 黑方等级分 (r1)</label>
            <input type="number" id="blackRating" value="2100" step="0.01" style="padding: 12px 16px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px; transition: all 0.3s ease; background: white;" onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)';" onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='none';">
        </div>
        
        <div style="display: flex; flex-direction: column;">
            <label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; font-size: 14px;">⚪ 白方等级分 (r2)</label>
            <input type="number" id="whiteRating" value="2100" step="0.01" style="padding: 12px 16px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px; transition: all 0.3s ease; background: white;" onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)';" onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='none';">
        </div>
        
        <div style="display: flex; flex-direction: column;">
            <label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; font-size: 14px;">🎯 棋份让子数 (Handicap)</label>
            <input type="number" id="handicap" value="0" min="0" max="9" style="padding: 12px 16px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px; transition: all 0.3s ease; background: white;" onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)';" onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='none';">
        </div>
        
        <div style="display: flex; flex-direction: column;">
            <label style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; font-size: 14px;">🏆 比赛结果</label>
            <select id="gameResult" style="padding: 12px 16px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px; transition: all 0.3s ease; background: white;" onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)';" onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='none';">
                <option value="黑胜">⚫ 黑胜</option>
                <option value="白胜">⚪ 白胜</option>
                <option value="和棋">🤝 和棋</option>
            </select>
        </div>
    </div>
    
    <!-- 计算按钮 -->
    <button onclick="calculateRating()" style="width: 100%; padding: 15px 30px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); margin-bottom: 30px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 25px rgba(102, 126, 234, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.3)';">
        🚀 计算新等级分与段位
    </button>
    
    <!-- 结果显示区域 -->
    <div id="result" style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 12px; padding: 30px; border: 2px solid rgba(102, 126, 234, 0.1); transition: all 0.3s ease;">
        <h2 style="text-align: center; font-size: 24px; font-weight: 700; color: #2c3e50; margin-bottom: 20px;">📊 计算结果</h2>
        <div style="color: #7f8c8d; text-align: center; padding: 30px; font-size: 16px;">请填写参数并点击计算按钮</div>
    </div>
</div>

<script>
function calculateRating() {
    const r1 = parseFloat(document.getElementById('blackRating').value);
    const r2 = parseFloat(document.getElementById('whiteRating').value);
    const handicap = parseInt(document.getElementById('handicap').value);
    const result = document.getElementById('gameResult').value;
    
    if (isNaN(r1) || isNaN(r2) || isNaN(handicap)) {
        document.getElementById('result').innerHTML = '<div style="color: #e74c3c; text-align: center; font-size: 18px; padding: 40px;">❌ 请输入有效数字</div>';
        return;
    }
    
    // EGF算法
    let adjusted_r1 = handicap > 0 ? r1 + (handicap - 0.5) * 100 : r1;
    
    const beta = (r) => -7 * Math.log(Math.min(3300, 3299.9) - Math.min(r, 3299.9));
    const con = (r) => Math.pow((3300 - r) / 200, 1.6);
    const bonus = (r) => Math.log(1 + Math.exp((2300 - r) / 80)) / 5;
    
    const Se1 = 1 / (1 + Math.exp(beta(r2) - beta(adjusted_r1)));
    const Se2 = 1 - Se1;
    
    let Sa1, Sa2;
    if (result === '黑胜') [Sa1, Sa2] = [1.0, 0.0];
    else if (result === '白胜') [Sa1, Sa2] = [0.0, 1.0];
    else [Sa1, Sa2] = [0.5, 0.5];
    
    const new_r1 = r1 + con(r1) * (Sa1 - Se1) + bonus(r1);
    const new_r2 = r2 + con(r2) * (Sa2 - Se2) + bonus(r2);
    
    const change1 = (new_r1 - r1).toFixed(2);
    const change2 = (new_r2 - r2).toFixed(2);
    
    function getRank(rating) {
        if (rating >= 2050) {
            const level = Math.floor((rating - 2050) / 100) + 1;
            const decimal = Math.floor(((rating - 2050) % 100) / 10);
            return `${level}.${decimal}D`;
        } else {
            const level = Math.floor((2050 - rating) / 100) + 1;
            const decimal = Math.floor((2050 - (level - 1) * 100 - rating) / 10);
            return `${level}.${decimal}K`;
        }
    }
    
    const se1_percent = (Se1 * 100).toFixed(1);
    const se2_percent = (Se2 * 100).toFixed(1);
    
    document.getElementById('result').innerHTML = `
        <h2 style="text-align: center; font-size: 24px; font-weight: 700; color: #2c3e50; margin-bottom: 20px;">📊 计算结果</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 25px;">
            <div style="background: white; padding: 20px; border-radius: 12px; border-left: 5px solid #667eea; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);">
                <div style="font-size: 18px; font-weight: 700; color: #2c3e50; margin-bottom: 10px;">⚫ 黑方 (Player 1)</div>
                <div style="margin-bottom: 8px; font-size: 15px;">原: ${r1} (<strong>${getRank(r1)}</strong>)</div>
                <div style="margin-bottom: 8px; font-size: 15px; font-weight: 700; color: #667eea;">新: ${new_r1.toFixed(2)} (<strong>${getRank(new_r1)}</strong>)</div>
                <div style="margin-bottom: 8px; font-size: 15px;">变化: <span style="font-weight: 600; color: ${change1 >= 0 ? '#27ae60' : '#e74c3c'};">${change1 > 0 ? '+' : ''}${change1}</span></div>
            </div>
            <div style="background: white; padding: 20px; border-radius: 12px; border-left: 5px solid #667eea; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);">
                <div style="font-size: 18px; font-weight: 700; color: #2c3e50; margin-bottom: 10px;">⚪ 白方 (Player 2)</div>
                <div style="margin-bottom: 8px; font-size: 15px;">原: ${r2} (<strong>${getRank(r2)}</strong>)</div>
                <div style="margin-bottom: 8px; font-size: 15px; font-weight: 700; color: #667eea;">新: ${new_r2.toFixed(2)} (<strong>${getRank(new_r2)}</strong>)</div>
                <div style="margin-bottom: 8px; font-size: 15px;">变化: <span style="font-weight: 600; color: ${change2 >= 0 ? '#27ae60' : '#e74c3c'};">${change2 > 0 ? '+' : ''}${change2}</span></div>
            </div>
        </div>
        <div style="margin-top: 25px; padding-top: 25px; border-top: 2px solid rgba(102, 126, 234, 0.1); text-align: center;">
            <div style="font-size: 20px; font-weight: 700; color: #2c3e50; margin-bottom: 15px;">📈 预期胜率对比 (Se)</div>
            <div style="width: 100%; height: 40px; background: #e9ecef; border-radius: 20px; overflow: hidden; display: flex; border: 2px solid rgba(102, 126, 234, 0.2); margin: 15px 0;">
                <div style="background: linear-gradient(135deg, #2c3e50, #34495e); color: white; width: ${se1_percent}%; display: flex; align-items: center; justify-content: center; font-weight: 700; transition: width 0.5s ease;">
                    ${se1_percent}%
                </div>
                <div style="background: linear-gradient(135deg, #bdc3c7, #95a5a6); color: white; width: ${se2_percent}%; display: flex; align-items: center; justify-content: center; font-weight: 700; transition: width 0.5s ease;">
                    ${se2_percent}%
                </div>
            </div>
            <div style="color: #7f8c8d; font-size: 14px; margin-top: 10px;">
                鼠标悬停在胜率条上查看精确数值
            </div>
        </div>
    `;
    
    // 添加结果动画效果
    const resultDiv = document.getElementById('result');
    resultDiv.classList.remove('new');
    resultDiv.classList.add('new');
    resultDiv.style.transform = 'scale(1.02)';
    resultDiv.style.boxShadow = '0 10px 30px rgba(102, 126, 234, 0.2)';
    setTimeout(() => {
        resultDiv.style.transform = 'scale(1)';
        resultDiv.style.boxShadow = '';
    }, 300);
}
</script>
