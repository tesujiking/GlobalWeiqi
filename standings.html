<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èµ›äº‹æ’å - å…¨çƒå›´æ£‹è¶…çº§è”èµ›</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* ä¸ºæ’åºè¡¨å¤´æ·»åŠ ç®­å¤´æŒ‡ç¤ºå™¨æ ·å¼ */
        thead th.sorted-asc::after { content: ' â–²'; }
        thead th.sorted-desc::after { content: ' â–¼'; }
    </style>
</head>
<body>

    <div class="main-content">
        <div class="page-title">
            <h1 id="tournament-title">ğŸ† æ­£åœ¨åŠ è½½èµ›äº‹ä¿¡æ¯...</h1>
            <p id="tournament-subtitle"></p>
        </div>

        <div class="stats-cards" id="stats-cards-container">
            </div>

        <div class="table-container">
            <div class="table-header">ğŸ“‹ æœ€ç»ˆæ’åè¡¨</div>
            <div class="table-note">ğŸ’¡ ç‚¹å‡»è¡¨å¤´å¯æ’åº | MMS=éº¦å…‹é©¬æ´ªåˆ†æ•°</div>
            <div class="table-wrapper">
                <table>
                    <thead id="standings-thead">
                        </thead>
                    <tbody id="standings-tbody">
                        <tr><td colspan="13" class="loading-cell">ğŸ”„ æ­£åœ¨åŠ è½½æ’åæ•°æ®...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
    (function() {
        // --- é…ç½®åŒºåŸŸ ---
        const API_BASE_URL = 'https://yaoshen.pythonanywhere.com'; 
        // â–¼â–¼â–¼ã€æ ¸å¿ƒä¿®æ”¹ã€‘â–¼â–¼â–¼
        // ä¸å†ä½¿ç”¨å›ºå®šçš„IDï¼Œè€Œæ˜¯ä» index.html è®¾ç½®çš„å…¨å±€å˜é‡ä¸­è¯»å–
        // å¦‚æœæ‰¾ä¸åˆ°å‚æ•°ï¼Œåˆ™é»˜è®¤åŠ è½½ ID ä¸º 1 çš„æ¯”èµ›ï¼Œä»¥é˜²ç›´æ¥æ‰“å¼€æ­¤æ–‡ä»¶
        const TOURNAMENT_ID = window.currentPageParams?.id || 1;
        // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²


        // --- æŒ‡å‘ä½ å·²æœ‰çš„APIåœ°å€ ---
        const apiUrl = `${API_BASE_URL}/api/tournament/${TOURNAMENT_ID}/final_standings/`;

        // --- DOM å…ƒç´ è·å– ---
        const titleEl = document.getElementById('tournament-title');
        const subtitleEl = document.getElementById('tournament-subtitle');
        const statsContainerEl = document.getElementById('stats-cards-container');
        const tableHeadEl = document.getElementById('standings-thead');
        const tableBodyEl = document.getElementById('standings-tbody');

        // --- ä¸»å‡½æ•°ï¼šåŠ è½½å¹¶æ¸²æŸ“æ•°æ® ---
        async function loadAndRenderStandings() {
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`ç½‘ç»œé”™è¯¯: ${response.status}`);
                const data = await response.json();
                if (!data.tournament_info || !data.standings) throw new Error("APIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ã€‚");
                
                renderHeaderAndStats(data.tournament_info);
                // â–¼â–¼â–¼ã€æ ¸å¿ƒä¿®æ”¹ï¼šå°†æ•´ä¸ª tournament_info å¯¹è±¡ä¼ è¿›å»ã€‘â–¼â–¼â–¼
                renderTable(data.standings, data.tournament_info);
                // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²
            } catch (error) {
                console.error('åŠ è½½æ’åå¤±è´¥:', error);
                if (titleEl) titleEl.textContent = 'âŒ åŠ è½½å¤±è´¥';
                if (tableBodyEl) tableBodyEl.innerHTML = `<tr><td colspan="13" class="error-cell">âš ï¸ åŠ è½½æ’åæ•°æ®å¤±è´¥: ${error.message}</td></tr>`;
            }
        }

        // --- è¾…åŠ©æ¸²æŸ“å‡½æ•° ---
        function renderHeaderAndStats(info) {
            titleEl.textContent = `ğŸ† ${info.name}`;
            subtitleEl.textContent = `æ’åæˆªè‡³ç¬¬ ${info.display_rounds_until} è½® - å…± ${info.total_rounds} è½®`;
            statsContainerEl.innerHTML = `
                <div class="stats-card"><h3>ğŸ“Š å‚èµ›äººæ•°</h3><div class="value">${info.participant_count}</div></div>
                <div class="stats-card"><h3>ğŸ¯ å·²èµ›è½®æ•°</h3><div class="value">${info.display_rounds_until}</div></div>
                <div class="stats-card"><h3>ğŸ¥‡ å…¨çƒæœ€å¼º</h3><div class="value">${info.winner_name || 'N/A'} ${info.winner_rank || ''}</div></div>
                <div class="stats-card"><h3>â­ å…¨èƒœ</h3><div class="value">${info.undefeated_count}äºº</div></div>
            `;
        }

        function renderTable(standings, tournament_info) {
            // â–¼â–¼â–¼ã€æ ¸å¿ƒä¿®æ”¹ï¼šä» tournament_info ä¸­è·å–è¦æ˜¾ç¤ºçš„è½®æ•°ã€‘â–¼â–¼â–¼
            const display_rounds_until = tournament_info.display_rounds_until;
            // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²
        
            // åŠ¨æ€ç”Ÿæˆè¡¨å¤´
            let headHTML = '<tr>';
            const headers = ['åºå·', 'æ’å', 'å§“å', 'æŠ¥åçº§åˆ«', 'åœ°åŒº', 'èƒœå±€æ•°'];
            headers.forEach((h, i) => headHTML += `<th onclick="sortTable(${i})">${h}</th>`);
            
            // â–¼â–¼â–¼ã€æ ¸å¿ƒä¿®æ”¹ï¼šåªå¾ªç¯åˆ°éœ€è¦æ˜¾ç¤ºçš„è½®æ•°ã€‘â–¼â–¼â–¼
            for (let i = 1; i <= display_rounds_until; i++) {
                headHTML += `<th onclick="sortTable(${headers.length + i - 1})">ç¬¬${i}è½®</th>`;
            }
            // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

            const finalHeaders = ['MMS', 'SOS', 'SOSOS'];
            const totalColumns = headers.length + display_rounds_until + finalHeaders.length;
            finalHeaders.forEach((h, i) => headHTML += `<th onclick="sortTable(${headers.length + display_rounds_until + i})">${h}</th>`);
            
            headHTML += '</tr>';
            tableHeadEl.innerHTML = headHTML;
            
            if (!standings || standings.length === 0) {
                tableBodyEl.innerHTML = `<tr><td colspan="${totalColumns}" class="loading-cell">æœ¬èµ›äº‹å°šæ— æ’åæ•°æ®ã€‚</td></tr>`;
                return;
            }

            let bodyHTML = '';
            standings.forEach((player, index) => {
                const roundResultsHTML = player.round_results_list?.map(result => {
                    // â–¼â–¼â–¼ æ–°ä»£ç ä»è¿™é‡Œå¼€å§‹ â–¼â–¼â–¼
                    let resultClass = '';
                    if (result.includes('+')) {
                        resultClass = 'result-win';    // èƒœå±€
                    } else if (result.includes('-')) {
                        resultClass = 'result-loss';   // è´¥å±€
                    } else if (result.includes('=')) {
                        resultClass = 'result-draw';   // æ–°å¢ï¼šå’Œæ£‹
                    }
                
                    const displayResult = `<span class="${resultClass}">${result}</span>`;
                    // â–²â–²â–² æ–°ä»£ç åˆ°è¿™é‡Œç»“æŸ â–²â–²â–²
                
                    return `<td style="font-family: monospace; text-align: center;">${displayResult}</td>`;
                }).join('') || '';

                bodyHTML += `
                    <tr class="${index % 2 === 0 ? 'impair' : 'pair'}">
                        <td class="rank-cell" style="text-align: center;">${player.competition_num || index + 1}</td>
                        <td class="rank-cell" style="text-align: center;">${player.display_rank || ''}</td>
                        <td class="name-cell">${player.player_name || 'æœªçŸ¥é€‰æ‰‹'}</td>
                        <td class="level-cell">${player.tournament_rank || ''}</td>
                        <td style="text-align: center;">${player.city || ''}</td>
                        <td class="wins-cell">${player.wins_upto_round ?? 'N/A'}</td>
                        ${roundResultsHTML}
                        <td style="font-weight: bold; text-align: center;">${player.total_score ?? 'N/A'}</td>
                        <td style="text-align: center;">${player.sos ?? 'N/A'}</td>
                        <td style="text-align: center;">${player.sosos ?? 'N/A'}</td>
                    </tr>
                `;
            });
            tableBodyEl.innerHTML = bodyHTML;
        }
        
        loadAndRenderStandings();

    })();

    // --- è¡¨æ ¼æ’åºåŠŸèƒ½ (æ— éœ€ä¿®æ”¹) ---
    function sortTable(columnIndex) {
        const table = document.querySelector('table');
        if (!table) return;
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        const currentDirection = table.getAttribute('data-sort-direction') === 'desc' ? 'asc' : 'desc';
        table.setAttribute('data-sort-direction', currentDirection);
        
        rows.sort((a, b) => {
            const aText = a.children[columnIndex]?.textContent.trim() || '';
            const bText = b.children[columnIndex]?.textContent.trim() || '';
            const aNum = parseFloat(aText);
            const bNum = parseFloat(bText);
            
            let comparison = 0;
            if (!isNaN(aNum) && !isNaN(bNum)) {
                comparison = aNum - bNum;
            } else {
                comparison = aText.localeCompare(bText, 'zh-CN', { numeric: true });
            }
            return currentDirection === 'asc' ? comparison : -comparison;
        });
        
        tbody.innerHTML = '';
        rows.forEach(row => tbody.appendChild(row));
        
        const headers = table.querySelectorAll('thead th');
        headers.forEach(header => header.classList.remove('sorted-asc', 'sorted-desc'));
        headers[columnIndex].classList.add(currentDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');

        tbody.querySelectorAll('tr').forEach((row, index) => {
            row.className = index % 2 === 0 ? 'impair' : 'pair';
        });
    }
    </script>
</body>
</html>
