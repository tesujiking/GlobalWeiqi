<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>比赛结果</title>
</head>
<body class="results-page">
    <div class="main-content">
        <div class="container">
            <h1 id="tournament-name">比赛名称加载中...</h1>
            <h2 id="round-info">轮次信息加载中...</h2>
            <div id="loading" style="text-align: center; padding: 50px; color: #666;">...正在加载...</div>
            <div id="error" style="display: none; text-align: center; padding: 50px; color: #e74c3c;"></div>
            <div id="pairings-list" class="pairings-list"></div>
        </div>
    </div>

    <script>
        // ▼▼▼【核心修改】加上IIFE“气泡外壳” ▼▼▼
        (function() {
            // 核心加载函数，负责获取数据和渲染页面
            function loadResults(params) {
                const tournamentId = params.tournament;
                const roundNumber = params.round;
                const loadingDiv = document.getElementById('loading');
                const errorDiv = document.getElementById('error');
                const list = document.getElementById('pairings-list');
                const tournamentNameH1 = document.getElementById('tournament-name');
                const roundInfoH2 = document.getElementById('round-info');
                
                if (!loadingDiv || !list) { return; }

                list.innerHTML = '';
                errorDiv.style.display = 'none';
                loadingDiv.style.display = 'block';
                tournamentNameH1.textContent = '比赛名称加载中...';
                roundInfoH2.textContent = '轮次信息加载中...';

                if (!tournamentId || !roundNumber) {
                    loadingDiv.style.display = 'none';
                    errorDiv.style.display = 'block';
                    errorDiv.textContent = '错误：加载时未提供 tournament 和 round 参数。';
                    return;
                }

                const apiUrl = `https://yaoshen.pythonanywhere.com/api/tournament/${tournamentId}/round/${roundNumber}/results/`;
                fetch(apiUrl)
                    .then(response => response.ok ? response.json() : Promise.reject(response))
                    .then(data => {
                        loadingDiv.style.display = 'none';
                        tournamentNameH1.textContent = data.tournament_info.name;
                        roundInfoH2.textContent = data.round_info.name;
                        if (data.pairings && data.pairings.length > 0) {
                            data.pairings.forEach(p => list.appendChild(createPairingCard(p)));
                        } else {
                            errorDiv.style.display = 'block';
                            errorDiv.textContent = '该轮次没有对阵信息。';
                        }
                    })
                    .catch(err => {
                        loadingDiv.style.display = 'none';
                        errorDiv.style.display = 'block';
                        errorDiv.textContent = `加载数据失败。请检查后台API是否正常或联系管理员。`;
                        console.error('Fetch error:', err);
                    });
            }

            // 核心卡片生成函数，负责将一条数据显示为一个卡片
            function createPairingCard(pairing) {
                const div = document.createElement('div');
                div.className = `pairing-item`;
                
                let simpleResult = 'VS', whiteIsWinner = false, blackIsWinner = false;
                if (pairing.status === 'COMPLETED') {
                    if (pairing.result_display.includes('白胜')) { simpleResult = '白胜'; whiteIsWinner = true; }
                    else if (pairing.result_display.includes('黑胜')) { simpleResult = '黑胜'; blackIsWinner = true; }
                    else { simpleResult = '和棋'; }
                }
                
                const whiteProb = (pairing.win_probability.white * 100).toFixed(1);
                const blackProb = (pairing.win_probability.black * 100).toFixed(1);
                const formatName = (player) => {
                    if (!player) return '';
                    const lastName = player.last_name || '';
                    const firstName = player.first_name || '';
                    if (lastName && firstName) return `<div class="name-line">${lastName}</div><div class="name-line">${firstName}</div>`;
                    return `<div class="name-line">${player.name}</div>`;
                };
                const formatHandicap = (h) => h > 0 ? `让${h}子` : '分先';
                const formatRating = (player) => {
                    const rank = player.rank || 'N/A';
                    const rating = player.rating ? player.rating.toFixed(2) : 'N/A';
                    return `${rank} (${rating})`;
                };
                const whiteHighlightClass = whiteIsWinner ? 'winner-highlight' : '';
                const blackHighlightClass = blackIsWinner ? 'winner-highlight' : '';

                div.innerHTML = `
                    <div class="pairing-content">
                        <div class="player-display ${whiteHighlightClass}">
                            <div class="player-color-indicator white">白</div>
                            <div class="avatar">${formatName(pairing.white_player)}</div>
                            <div class="player-region">${pairing.white_player.region || '&nbsp;'}</div>
                            <div class="player-rating-info">${formatRating(pairing.white_player)}</div>
                        </div>
                        <div class="result-display">
                            <div class="round-title">第 ${pairing.board_number} 台</div>
                            <div class="handicap-info">${formatHandicap(pairing.handicap)}</div>
                            ${pairing.status === 'COMPLETED' 
                                ? `<div class="final-result">${simpleResult}</div><div class="result-detail">${pairing.result_detail}</div>` 
                                : `<div class="final-result" style="color: #4a7ac9; font-weight: normal;">进行中...</div>`
                            }
                        </div>
                        <div class="player-display ${blackHighlightClass}">
                            <div class="player-color-indicator black">黑</div>
                            <div class="avatar">${formatName(pairing.black_player)}</div>
                            <div class="player-region">${pairing.black_player.region || '&nbsp;'}</div>
                            <div class="player-rating-info">${formatRating(pairing.black_player)}</div>
                        </div>
                    </div>
                    <div class="win-prob-bar">
                        <div class="prob-white" style="width: ${whiteProb}%">${whiteProb}%</div>
                        <div class="prob-black" style="width: ${blackProb}%">${blackProb}%</div>
                    </div>
                `;
                return div;
            }

            // “双模式”启动器，逻辑保持不变
            const paramsFromUrl = new URLSearchParams(window.location.search);
            if (paramsFromUrl.has('tournament')) {
                const standaloneParams = Object.fromEntries(paramsFromUrl.entries());
                loadResults(standaloneParams);
            } 
            else if (window.currentPageParams) {
                loadResults(window.currentPageParams);
                delete window.currentPageParams;
            }
        })(); // <--- 【核心修改】末尾的括号立刻执行上面的所有代码
        // ▲▲▲【修改结束】▲▲▲
    </script>
</body>
</html>
