<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨å¹³å°é€‰æ‰‹ç­‰çº§åˆ†æ’è¡Œæ¦œ - å…¨çƒå›´æ£‹è¶…çº§è”èµ›</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="stylesheet" href="style.css">

</head>
<body>

    <div class="main-content">
        <div class="page-title">
            <h1>ğŸ† å…¨å¹³å°é€‰æ‰‹ç­‰çº§åˆ†æ’è¡Œæ¦œ</h1>
            <p>æŸ¥çœ‹æ‰€æœ‰å‚èµ›é€‰æ‰‹çš„ç­‰çº§åˆ†æ’åå’Œå¯¹å±€å†å²</p>
        </div>

        <div class="table-container">
            <h2 class="table-header">ğŸ“ˆ æ‰€æœ‰é€‰æ‰‹åˆ—è¡¨</h2>
            <p class="table-note">ğŸ’¡ æç¤ºï¼šç‚¹å‡»ä»»æ„é€‰æ‰‹è¡Œï¼Œå¯æŸ¥çœ‹è¯¥é€‰æ‰‹çš„è¯¦ç»†å¯¹å±€å†å²ã€‚</p>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>ğŸ… æ’å</th>
                            <th>ğŸ‘¤ å§“å</th>
                            <th>ğŸŒ åœ°åŒº</th>
                            <th style="text-align: center;">ğŸ¯ å½“å‰ç­‰çº§åˆ†</th>
                            <th style="text-align: center;">ğŸ† æ ‡å‡†æ®µä½</th>
                            <th style="text-align: center;">âš”ï¸ æ€»å¯¹å±€æ•°</th>
                        </tr>
                    </thead>
                    <tbody id="player-list-body">
                        <tr><td colspan="6" class="loading-cell">ğŸ”„ æ­£åœ¨åŠ è½½é€‰æ‰‹åˆ—è¡¨...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="historyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalPlayerName"></h3>
                <button id="closeModal" class="close-button">&times;</button>
            </div>
            <div class="modal-body">
                <div id="statsContainer" class="stats-container"></div>
                <div id="chartContainer" class="chart-container" style="display: none;">
                    <canvas id="playerRatingChart"></canvas>
                </div>
                <div id="tableContainer" class="history-table">
                    <p class="loading-cell">ğŸ”„ æ­£åœ¨åŠ è½½å¯¹å±€å†å²...</p>
                </div>
            </div>
        </div>
    </div>

<script>
    (function() {
        // --- å…¨å±€å˜é‡å’Œå¸¸é‡ ---
        let playerChartInstance = null;
        const API_BASE_URL = 'https://yaoshen.pythonanywhere.com';

        // --- è¾…åŠ©å‡½æ•° (ä¿æŒä¸å˜) ---
        function calculateRankFromRating(rating) { /* ... å†…å®¹ä¸å˜ ... */ }
        function calculateAndDisplayStats(ratingData) { /* ... å†…å®¹ä¸å˜ ... */ }

        // --- æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ---

        // â–¼â–¼â–¼ã€æ ¸å¿ƒä¿®æ”¹åŒºåŸŸã€‘â–¼â–¼â–¼
        
        // æ­¥éª¤1ï¼šä¸å†éœ€è¦å•ç‹¬çš„ attachClickListeners å‡½æ•°
        // æˆ‘ä»¬ç›´æ¥ä¸ºçˆ¶å®¹å™¨ç»‘å®šä¸€æ¬¡æ€§çš„ã€æ°¸ä¹…æœ‰æ•ˆçš„äº‹ä»¶ç›‘å¬å™¨

        const playerListBody = document.getElementById('player-list-body');
        if (playerListBody) {
            playerListBody.addEventListener('click', function(event) {
                // event.target æ˜¯ç”¨æˆ·å®é™…ç‚¹å‡»çš„å…ƒç´  (å¯èƒ½æ˜¯<td>, <span>ç­‰)
                // .closest('.player-row') ä¼šä»è¢«ç‚¹å‡»çš„å…ƒç´ å¼€å§‹ï¼Œå‘ä¸ŠæŸ¥æ‰¾æœ€è¿‘çš„ class="player-row" çš„ç¥–å…ˆå…ƒç´ 
                const row = event.target.closest('.player-row');

                // å¦‚æœç¡®å®ç‚¹å‡»åœ¨äº†ä¸€ä¸ªé€‰æ‰‹è¡Œå†…éƒ¨ï¼Œåˆ™æ‰§è¡Œå¼¹çª—é€»è¾‘
                if (row) {
                    const playerId = row.dataset.playerId;
                    const playerName = row.dataset.playerName;
                    openHistoryModal(playerId, playerName);
                }
            });
        }

        // æ­¥éª¤2ï¼šå°†å¼¹çª—é€»è¾‘æå–åˆ°ä¸€ä¸ªç‹¬ç«‹çš„å‡½æ•°ä¸­
        function openHistoryModal(playerId, playerName) {
            const modal = document.getElementById('historyModal');
            const modalPlayerName = document.getElementById('modalPlayerName');
            const chartContainer = document.getElementById('chartContainer');
            const tableContainer = document.getElementById('tableContainer');
            const statsContainer = document.getElementById('statsContainer');
            const closeModalBtn = document.getElementById('closeModal');

            modalPlayerName.textContent = `${playerName} çš„å†å²è®°å½•`;
            tableContainer.innerHTML = '<p class="loading-cell">ğŸ”„ æ­£åœ¨åŠ è½½å¯¹å±€å†å²...</p>';
            statsContainer.innerHTML = '';
            chartContainer.style.display = 'none';
            modal.classList.add('show');

            fetch(`${API_BASE_URL}/players/${playerId}/match_history/`)
                .then(response => response.json())
                .then(data => {
                    // ... æ­¤å¤„æ‰€æœ‰è·å–æ•°æ®å¹¶å¡«å……æ¨¡æ€æ¡†çš„é€»è¾‘ï¼Œéƒ½ä¿æŒä¸å˜ ...
                    if (data.chart_data && data.chart_data.datasets[0].data) {
                        calculateAndDisplayStats(data.chart_data.datasets[0].data);
                    }
                    if (data.chart_data && data.chart_data.datasets[0].data.length > 1) {
                        chartContainer.style.display = 'block';
                        const ctx = document.getElementById('playerRatingChart').getContext('2d');
                        if (playerChartInstance) { playerChartInstance.destroy(); }
                        const yValuesOnly = data.chart_data.datasets[0].data.map(item => item.y);
                        const chartDisplayData = JSON.parse(JSON.stringify(data.chart_data));
                        chartDisplayData.datasets[0].data = yValuesOnly;
                        const dataMin = Math.min(...yValuesOnly);
                        const dataMax = Math.max(...yValuesOnly);
                        const padding = (dataMax - dataMin) * 0.1 || 5;
                        playerChartInstance = new Chart(ctx, { type: 'line', data: chartDisplayData, options: { /* ... */ } });
                    } else {
                        chartContainer.style.display = 'none';
                    }
                    if (data.matches && data.matches.length > 0) {
                        let tableHtml = `<h4>ğŸ“‹ å¯¹å±€åˆ—è¡¨</h4><table>...`; // è¡¨æ ¼HTMLéƒ¨åˆ†ä¸å˜
                        data.matches.forEach(match => {
                            // ... å¡«å……è¡¨æ ¼è¡Œçš„é€»è¾‘ä¸å˜ ...
                            let rankBeforeFormatted = 'N/A';
                            if (match.player_rank_before !== null && match.player_rank_before !== undefined) { rankBeforeFormatted = parseFloat(match.player_rank_before).toFixed(2); }
                            const resultClass = match.result === 'èƒœ' ? 'win-result' : 'lose-result';
                            const playerDeltaClass = match.player_delta.startsWith('+') ? 'positive-delta' : 'negative-delta';
                            const opponentDeltaClass = match.opponent_delta.startsWith('+') ? 'positive-delta' : 'negative-delta';
                            tableHtml += `<tr><td>${match.match_date}</td><td>${match.tournament_name}</td><td style="text-align: center;">${match.round_number}</td><td style="text-align: center;">${rankBeforeFormatted}</td><td>${match.opponent_name}</td><td style="text-align: center;">${match.handicap}</td><td style="text-align: center;" class="${resultClass}">${match.result}</td><td style="text-align: center;" class="${playerDeltaClass}">${match.player_delta}</td><td style="text-align: center;" class="${opponentDeltaClass}">${match.opponent_delta}</td></tr>`;
                        });
                        tableHtml += `</tbody></table>`;
                        tableContainer.innerHTML = tableHtml;
                    } else {
                        tableContainer.innerHTML = '<p class="loading-cell">ğŸ“‹ è¯¥é€‰æ‰‹å°šæ— å·²å®Œæˆçš„å¯¹å±€è®°å½•ã€‚</p>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching match history:', error);
                    tableContainer.innerHTML = '<p class="error-cell">âš ï¸ åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚</p>';
                });

            const closeModal = () => modal.classList.remove('show');
            closeModalBtn.onclick = closeModal;
            modal.onclick = function(event) { if (event.target == modal) { closeModal(); }};
        }

        // æ­¥éª¤3ï¼šä¿®æ”¹ loadPlayerListï¼Œè®©å®ƒä¸å†è°ƒç”¨ attachClickListeners
        function loadPlayerList() {
            const playerListBody = document.getElementById('player-list-body');
            fetch(`${API_BASE_URL}/api/players/`)
                .then(response => {
                    if (!response.ok) { throw new Error('ç½‘ç»œå“åº”é”™è¯¯'); }
                    return response.json();
                })
                .then(data => {
                    let tableRowsHtml = '';
                    if (data.players && data.players.length > 0) {
                        data.players.forEach((player, index) => {
                            tableRowsHtml += `
                                <tr class="player-row" data-player-id="${player.id}" data-player-name="${player.full_name}">
                                    <td class="rank-cell">${index + 1}</td>
                                    <td class="name-cell">${player.full_name}</td>
                                    <td class="region-cell">${player.city || player.country || ''}</td>
                                    <td class="rating-cell">${player.current_rating.toFixed(2)}</td>
                                    <td class="rank-cell-display">${player.standard_rank}</td>
                                    <td class="games-cell">${player.total_games_played}</td>
                                </tr>
                            `;
                        });
                    } else {
                        tableRowsHtml = '<tr><td colspan="6" class="loading-cell">ğŸ† ç³»ç»Ÿä¸­å°šæ— æ´»è·ƒé€‰æ‰‹ã€‚</td></tr>';
                    }
                    playerListBody.innerHTML = tableRowsHtml;
                    // ã€æ³¨æ„ã€‘è¿™é‡Œä¸å†éœ€è¦è°ƒç”¨ attachClickListeners();
                })
                .catch(error => {
                    console.error('åŠ è½½é€‰æ‰‹åˆ—è¡¨å¤±è´¥:', error);
                    playerListBody.innerHTML = '<tr><td colspan="6" class="error-cell">âš ï¸ åŠ è½½é€‰æ‰‹åˆ—è¡¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸ã€‚</td></tr>';
                });
        }

        // --- å¯åŠ¨ç¨‹åº ---
        loadPlayerList();
        
    })(); // ç«‹å³æ‰§è¡Œ
</script>
    
</body>
</html>
