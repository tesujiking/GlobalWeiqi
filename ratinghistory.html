<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨å¹³å°é€‰æ‰‹ç­‰çº§åˆ†æ’è¡Œæ¦œ - å…¨çƒå›´æ£‹è¶…çº§è”èµ›</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: transparent;
            min-height: 100vh;
            color: #333;
            margin: 0;
            padding: 0;
        }

        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            width: 100%;
            margin: 0;
            background: transparent;
            padding: 40px;
        }

        .page-title {
            text-align: center;
            margin-bottom: 30px;
        }

        .page-title h1 {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .page-title p {
            color: #7f8c8d;
            font-size: 16px;
        }

        /* è¡¨æ ¼æ ·å¼ */
        .table-container {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            padding: 30px;
            border: 2px solid rgba(102, 126, 234, 0.1);
            overflow: hidden;
        }

        .table-header {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .table-note {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        .table-wrapper {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        thead th {
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tbody tr {
            border-bottom: 1px solid #e9ecef;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        tbody tr:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
            transform: translateY(-1px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        tbody td {
            padding: 15px 12px;
            font-size: 14px;
        }

        .rank-cell {
            font-weight: 700;
            color: #667eea;
        }

        .name-cell {
            font-weight: 600;
            color: #2c3e50;
        }

        .rating-cell {
            font-weight: 700;
            color: #667eea;
            text-align: center;
        }

        .rank-cell-display {
            text-align: center;
            color: #34495e;
            font-weight: 500;
        }

        .games-cell {
            text-align: center;
            color: #7f8c8d;
        }

        .region-cell {
            color: #7f8c8d;
        }

        .loading-cell {
            text-align: center;
            color: #7f8c8d;
            padding: 30px;
            font-style: italic;
        }

        .error-cell {
            text-align: center;
            color: #e74c3c;
            padding: 30px;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 2000;
            display: none;
            overflow-y: auto;
        }

        .modal.show {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 1000px;
            margin-top: 50px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
        }

        .close-button {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 30px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .stats-container {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .history-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .history-table h4 {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 20px;
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .history-table table {
            font-size: 13px;
        }

        .history-table thead {
            background: #f8f9fa;
            color: #2c3e50;
        }

        .history-table thead th {
            padding: 12px 8px;
            font-size: 12px;
        }

        .history-table tbody td {
            padding: 10px 8px;
        }

        .win-result {
            color: #27ae60;
            font-weight: 600;
        }

        .lose-result {
            color: #e74c3c;
            font-weight: 600;
        }

        .positive-delta {
            color: #27ae60;
            font-family: 'Courier New', monospace;
        }

        .negative-delta {
            color: #e74c3c;
            font-family: 'Courier New', monospace;
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }
            
            .page-title h1 {
                font-size: 24px;
            }
            
            .modal-content {
                margin-top: 20px;
            }
            
            .modal-body {
                padding: 20px;
            }
            
            table {
                font-size: 12px;
            }
            
            thead th,
            tbody td {
                padding: 8px 6px;
            }
        }
    </style>
</head>
<body>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="main-content">
        <div class="page-title">
            <h1>ğŸ† å…¨å¹³å°é€‰æ‰‹ç­‰çº§åˆ†æ’è¡Œæ¦œ</h1>
            <p>æŸ¥çœ‹æ‰€æœ‰å‚èµ›é€‰æ‰‹çš„ç­‰çº§åˆ†æ’åå’Œå¯¹å±€å†å²</p>
        </div>

        <div class="table-container">
            <h2 class="table-header">ğŸ“ˆ æ‰€æœ‰é€‰æ‰‹åˆ—è¡¨</h2>
            <p class="table-note">ğŸ’¡ æç¤ºï¼šç‚¹å‡»ä»»æ„é€‰æ‰‹è¡Œï¼Œå¯æŸ¥çœ‹è¯¥é€‰æ‰‹çš„è¯¦ç»†å¯¹å±€å†å²ã€‚</p>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>ğŸ… æ’å</th>
                            <th>ğŸ‘¤ å§“å</th>
                            <th>ğŸŒ åœ°åŒº</th>
                            <th style="text-align: center;">ğŸ¯ å½“å‰ç­‰çº§åˆ†</th>
                            <th style="text-align: center;">ğŸ† æ ‡å‡†æ®µä½</th>
                            <th style="text-align: center;">âš”ï¸ æ€»å¯¹å±€æ•°</th>
                        </tr>
                    </thead>
                    <tbody id="player-list-body">
                        <tr><td colspan="6" class="loading-cell">ğŸ”„ æ­£åœ¨åŠ è½½é€‰æ‰‹åˆ—è¡¨...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ç°ä»£åŒ–æ¨¡æ€æ¡† -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalPlayerName"></h3>
                <button id="closeModal" class="close-button">&times;</button>
            </div>
            <div class="modal-body">
                <div id="statsContainer" class="stats-container"></div>
                <div id="chartContainer" class="chart-container" style="display: none;">
                    <canvas id="playerRatingChart"></canvas>
                </div>
                <div id="tableContainer" class="history-table">
                    <p class="loading-cell">ğŸ”„ æ­£åœ¨åŠ è½½å¯¹å±€å†å²...</p>
                </div>
            </div>
        </div>
    </div>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- å…¨å±€å˜é‡å’Œå¸¸é‡ ---
        let playerChartInstance = null;
        const API_BASE_URL = 'https://yaoshen.pythonanywhere.com'; // ä½ çš„åç«¯APIåœ°å€

        // --- è¾…åŠ©å‡½æ•° ---
        function calculateRankFromRating(rating) {
            if (rating === null || rating === undefined) { return "N/A"; }
            try {
                rating = parseFloat(rating);
                if (isNaN(rating)) { return "Error"; }
                if (rating >= 2050) {
                    const baseLevel = Math.floor((rating - 2050) / 100);
                    const integerRank = baseLevel + 1;
                    const ratingInBlock = (rating - 2050) % 100;
                    const decimalPart = Math.floor(ratingInBlock / 10);
                    return `${integerRank}.${decimalPart}D`;
                } else {
                    const integerRank = Math.floor((2050 - rating) / 100) + 1;
                    const topOfBand = 2050 - (integerRank - 1) * 100;
                    const distanceFromTop = topOfBand - rating;
                    const decimalPart = Math.floor(distanceFromTop / 10);
                    return `${integerRank}.${decimalPart}K`;
                }
            } catch (e) { return "Error"; }
        }

        function calculateAndDisplayStats(ratingData) {
            const statsContainer = document.getElementById('statsContainer');
            const gameRatings = ratingData.slice(1).map(d => d.y);
            const numGames = gameRatings.length;
            if (numGames < 7) {
                statsContainer.innerHTML = '';
                return;
            }
            const recentGameRatings = gameRatings.slice(-20);
            const n = recentGameRatings.length;
            const sum = recentGameRatings.reduce((a, b) => a + b, 0);
            const mean = sum / n;
            const variance = n > 1 ? recentGameRatings.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b, 0) / (n - 1) : 0;
            const stdDev = Math.sqrt(variance);
            const meanRank = calculateRankFromRating(mean);
            const rankSuffix = meanRank.slice(-1);
            const meanFormatted = mean.toFixed(2);
            const stdDevAsLevel = (stdDev / 100).toFixed(2);
            const stdDevFormatted = stdDev.toFixed(2);
            statsContainer.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                    <div><strong>è¿‘æœŸå®åŠ› (å¹³å‡æ°´å¹³):</strong> <span style="font-family: 'Courier New', monospace; color: #667eea; font-weight: 600;">${meanRank} (${meanFormatted})</span></div>
                    <div><strong>çŠ¶æ€ç¨³å®šåº¦ (æ ‡å‡†å·®):</strong> <span style="font-family: 'Courier New', monospace; color: #667eea; font-weight: 600;">${stdDevAsLevel}${rankSuffix} (${stdDevFormatted})</span></div>
                </div>
                <p style="font-size: 12px; color: #7f8c8d; margin-top: 10px;">ğŸ“ˆ æ ¹æ®æœ€è¿‘ ${n} ç›¤å¯¹å±€è®¡ç®—ã€‚æ ‡å‡†å·®è¶Šå°ï¼ŒçŠ¶æ€è¶Šç¨³å®šã€‚</p>
            `;
        }

        // --- æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ---

        // å‡½æ•°ï¼šä¸ºæ‰€æœ‰.player-rowå…ƒç´ ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼ˆå¼¹çª—é€»è¾‘ï¼‰
        function attachClickListeners() {
            document.querySelectorAll('.player-row').forEach(row => {
                row.addEventListener('click', function() {
                    const playerId = this.dataset.playerId;
                    const playerName = this.dataset.playerName;
                    const modal = document.getElementById('historyModal');
                    const modalPlayerName = document.getElementById('modalPlayerName');
                    const chartContainer = document.getElementById('chartContainer');
                    const tableContainer = document.getElementById('tableContainer');
                    const statsContainer = document.getElementById('statsContainer');
                    const closeModalBtn = document.getElementById('closeModal');

                    modalPlayerName.textContent = `${playerName} çš„å†å²è®°å½•`;
                    tableContainer.innerHTML = '<p class="loading-cell">ğŸ”„ æ­£åœ¨åŠ è½½å¯¹å±€å†å²...</p>';
                    statsContainer.innerHTML = '';
                    chartContainer.style.display = 'none';
                    modal.classList.add('show');

                    fetch(`${API_BASE_URL}/players/${playerId}/match_history/`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.chart_data && data.chart_data.datasets[0].data) {
                               calculateAndDisplayStats(data.chart_data.datasets[0].data);
                            }
                            if (data.chart_data && data.chart_data.datasets[0].data.length > 1) {
                                chartContainer.style.display = 'block';
                                const ctx = document.getElementById('playerRatingChart').getContext('2d');
                                if (playerChartInstance) { playerChartInstance.destroy(); }
                                
                                const yValuesOnly = data.chart_data.datasets[0].data.map(item => item.y);
                                const chartDisplayData = JSON.parse(JSON.stringify(data.chart_data));
                                chartDisplayData.datasets[0].data = yValuesOnly;
                                const dataMin = Math.min(...yValuesOnly);
                                const dataMax = Math.max(...yValuesOnly);
                                const padding = (dataMax - dataMin) * 0.1 || 5;
                                
                                playerChartInstance = new Chart(ctx, {
                                    type: 'line',
                                    data: chartDisplayData,
                                    options: { /* ... å®Œæ•´çš„å›¾è¡¨Options ... */ }
                                });
                            } else {
                                chartContainer.style.display = 'none';
                            }
                            if (data.matches && data.matches.length > 0) {
                                let tableHtml = `
                                    <h4>ğŸ“‹ å¯¹å±€åˆ—è¡¨</h4>
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>ğŸ“… æ—¥æœŸ</th>
                                                <th>ğŸ† èµ›äº‹</th>
                                                <th style="text-align: center;">ğŸ”„ è½®æ¬¡</th>
                                                <th style="text-align: center;">ğŸ¯ å½“æ—¶ç­‰çº§åˆ†</th>
                                                <th>ğŸ‘¤ å¯¹æ‰‹</th>
                                                <th style="text-align: center;">âš–ï¸ æ£‹ä»½</th>
                                                <th style="text-align: center;">ğŸ… èƒœè´Ÿ</th>
                                                <th style="text-align: center;">ğŸ“ˆ æœ¬äººåˆ†å˜</th>
                                                <th style="text-align: center;">ğŸ“‰ å¯¹æ‰‹åˆ†å˜</th>
                                            </tr>
                                        </thead>
                                        <tbody>`;
                                data.matches.forEach(match => {
                                    let rankBeforeFormatted = 'N/A';
                                    if (match.player_rank_before !== null && match.player_rank_before !== undefined) {
                                        rankBeforeFormatted = parseFloat(match.player_rank_before).toFixed(2);
                                    }
                                    const resultClass = match.result === 'èƒœ' ? 'win-result' : 'lose-result';
                                    const playerDeltaClass = match.player_delta.startsWith('+') ? 'positive-delta' : 'negative-delta';
                                    const opponentDeltaClass = match.opponent_delta.startsWith('+') ? 'positive-delta' : 'negative-delta';
                                    
                                    tableHtml += `
                                        <tr>
                                            <td style="color: #7f8c8d;">${match.match_date}</td>
                                            <td>${match.tournament_name}</td>
                                            <td style="text-align: center;">${match.round_number}</td>
                                            <td style="text-align: center;">${rankBeforeFormatted}</td>
                                            <td>${match.opponent_name}</td>
                                            <td style="text-align: center;">${match.handicap}</td>
                                            <td style="text-align: center;" class="${resultClass}">${match.result}</td>
                                            <td style="text-align: center;" class="${playerDeltaClass}">${match.player_delta}</td>
                                            <td style="text-align: center;" class="${opponentDeltaClass}">${match.opponent_delta}</td>
                                        </tr>
                                    `;
                                });
                                tableHtml += `</tbody></table>`;
                                tableContainer.innerHTML = tableHtml;
                            } else {
                                tableContainer.innerHTML = '<p class="loading-cell">ğŸ“‹ è¯¥é€‰æ‰‹å°šæ— å·²å®Œæˆçš„å¯¹å±€è®°å½•ã€‚</p>';
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching match history:', error);
                            tableContainer.innerHTML = '<p class="error-cell">âš ï¸ åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚</p>';
                        });

                    const closeModal = () => modal.classList.remove('show');
                    closeModalBtn.onclick = closeModal;
                    modal.onclick = function(event) { if (event.target == modal) { closeModal(); }};
                });
            });
        }

        // å‡½æ•°ï¼šåŠ è½½å¹¶æ˜¾ç¤ºæ‰€æœ‰é€‰æ‰‹åˆ—è¡¨
        function loadPlayerList() {
            const playerListBody = document.getElementById('player-list-body');
            fetch(`${API_BASE_URL}/api/players/`)
                .then(response => {
                    if (!response.ok) { throw new Error('ç½‘ç»œå“åº”é”™è¯¯'); }
                    return response.json();
                })
                .then(data => {
                    let tableRowsHtml = '';
                    if (data.players && data.players.length > 0) {
                        data.players.forEach((player, index) => {
                            tableRowsHtml += `
                                <tr class="player-row" data-player-id="${player.id}" data-player-name="${player.full_name}">
                                    <td class="rank-cell">${index + 1}</td>
                                    <td class="name-cell">${player.full_name}</td>
                                    <td class="region-cell">${player.city || player.country || ''}</td>
                                    <td class="rating-cell">${player.current_rating.toFixed(2)}</td>
                                    <td class="rank-cell-display">${player.standard_rank}</td>
                                    <td class="games-cell">${player.total_games_played}</td>
                                </tr>
                            `;
                        });
                    } else {
                        tableRowsHtml = '<tr><td colspan="6" class="loading-cell">ğŸ† ç³»ç»Ÿä¸­å°šæ— æ´»è·ƒé€‰æ‰‹ã€‚</td></tr>';
                    }
                    playerListBody.innerHTML = tableRowsHtml;
                    attachClickListeners(); // æ•°æ®åŠ è½½å¹¶æ¸²æŸ“å®Œæˆåï¼Œå†ä¸ºæ–°çš„è¡Œç»‘å®šç‚¹å‡»äº‹ä»¶
                })
                .catch(error => {
                    console.error('åŠ è½½é€‰æ‰‹åˆ—è¡¨å¤±è´¥:', error);
                    playerListBody.innerHTML = '<tr><td colspan="6" class="error-cell">âš ï¸ åŠ è½½é€‰æ‰‹åˆ—è¡¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸ã€‚</td></tr>';
                });
        }

        // --- å¯åŠ¨ç¨‹åº ---
        loadPlayerList();
    });
</script>

</body>
</html>
